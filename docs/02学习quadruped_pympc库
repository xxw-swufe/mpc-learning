## README.md：为了学习动力学和mpc相关东西，了解整体框架，以及找到能够直接复用的成果、

## todo.md：
	1周 MPC基础：
1.学习离散时间系统模型（状态空间模型 State-space）
2.学习线性/非线性 MPC 原理（LQR、NMPC 基础）
3.熟悉机器人动力学模型（质心模型、落足点、四足/双足简化模型）
4.安装 CasADi（符号优化求解器）
5.构建系统动力学方程（离散化）
  2周 MPC 控制器搭建：
1.目标函数设计（tracking cost、smoothness cost）
2.约束建模（输入约束、接触力约束、关节限制）
3.使用 CasADi + IPOPT 构建 NMPC 求解器
4.基础 MPC 循环（predict → optimize → control）
5.实现最小可运行 MPC demo（无噪声）
  3周 MPC 实时化与机器人接口：
1.实现 50–200 Hz 控制循环（定时器、缓存）
2.状态估计接口（IMU、足端力、里程计 State Estimation）
3.MPC Warm start 技术（前一周期解的初始化）
4.Latency compensation（延迟补偿）
5.输出参考指令（速度、落点位置、接触序列）
  4周 MPC 与底层控制集成：
1.MPC 输出映射至电机控制接口（期望关节角/速度/力）
2.与低层 1kHz 控制器对接（PD/FOC）
3.故障保护（QP fail-safe、Fallback PD 控制）
4.实机模拟证（IsaacGym/IsaacLab 中运行）
5.完成可运行的高频 MPC 控制模块


##doc.md：决策
1 决定采用单刚体SRC作为系统动力学方程，centroidal_model_nominal.py，acados四阶rk进行离散
2 第二周的任务 
2.1 centroidal_nmpc_nominal.py：基础版本（更容易跑通）直接用原版不修改
centroidal_nmpc_input_rates.py：加了输入变化率相关的结构（更平滑、但更复杂）
2.2 尽量采用原版
2.2决定config.py为定义约束世界，和机器人背景，具体约束建模文件根据：
摩擦锥约束实现，约束集成方式：centroidal_nmpc_nominal.py
接触动力学处理：centroidal_model_nominal.py
JAX采样版本的处理方式：centroidal_nmpc_jax.py
配置参数：config.py
2.3 CasADi + IPOPT 







##log.md：记录旅程
###### 2025-12-15
完成：

进行中：

踩坑及解决：

## 2025-12-14
完成：1.1阶段所有任务
2.阅读代码，并修改错误
A：用 CasADi 的 SX 符号变量定义 NMPC 的状态 x、输入 u、参数 p 以及隐式动力学方程，
导出给 acados（export_robot_model），生成 AcadosModel()，用于 NMPC 求解。包含基本的质心/姿态状态（12维），
四个脚端位置（12维），积分状态（6维，积分补偿（消除稳态误差））
B：定义状态向量30维，states_dot状态变化，输入 inputs脚端速度（12维）地面反力（12维），参数 param摩擦系数，
外力外矩扰动补偿等。
C：forward_dynamics主函数，获取各类力，COM、脚位置、姿态角、角速度，param。写主要公式

进行中：

踩坑及解决：
## 2025-12-15
完成：拆解了目标函数和约束建模，集成创建了求解器
     实现了MPC循环：读当前状态，生成接触序列，生成参考轨迹，求解优化，执行控制并推进状态
	实现了mpc demo

进行中：坑3经过加竖直力平衡硬约束，fz保持不变，但是仍然是两条腿受力

踩坑及解决：
	1,mpc demo中numpy和casADI来回用写法混乱-----AI纠正
	2，系统在“往下掉”，期望 v_ref=[0.2, 0, 0]，但 v_now 的 z 速度越来越负-----A。修复reshape问题，casADI
和numpy reshape顺序相反   B。约束边界建模错误，法向力上界下界均是0
	3,速度不断加快，水平力过大，导致fz变成0，求解失败-----------还是前面那两个问题，版本交替时错误又复原了，然
后加了   返回 w_opt + 内置 warm-start + Δu 正则 + IPOPT warm-start 参数   A：原地站立没问题。B：前进老
问题


###### 2025-12-16
完成：完成了MPC demo 静止版本，前进版本
	完全独立出来MPC版本，并上传至库

	第三周任务，3.1实现基础的，但是还没有真实接口尝试，且有前期速度增长慢的问题
				3.2 预留了状态接口函数，后续进isaac，或者真机再加
				3.3 完成
				3.4 完成延迟补偿代码的编写，测试完毕，基本成功
				3.5 完成静态的基本的，动态和步态预留了接口，后面在调整
	完成latency版本，补充传感器接口，步态接口，完善延迟补偿




进行中：0-0.2-0版本有问题--------未解决########
	将solve和apply解耦出来，25与50hz，但是前1秒速度增长0-0-0-0，很慢，未解决##########

踩坑及解决： 
1.  75行的问题，通过----------修改 1 & 2：放松力上界fz_max：300N → 500N，修改 3：接触腿最小力约束
fz_contact_min：10N,- 新增: 力方差惩罚项（权重50.0）- 足端速度约束，原理不进行速度约束
，会导致在足端fx方向拖着移动，导致速度不断增加，从强约束（影响维度）到软约束，更大惩罚
机制: 鼓励四条腿均匀分担重量。
已经使四条腿支撑平衡。--------但是又有新的问题。速度闭环在加速方向“刹不住”---------1.
把“参考速度的变化”从“无限大加速度的阶跃”变成了“有最大加速度的平滑变化”。
原来（阶跃响应）：
修改后（渐进响应）：
  tau = 0.5  # 时间常数
  alpha = 1.0 - exp(-k*dt/tau)  # 渐进因子
  v_ref_k = v_now + (v_cmd - v_now) * alpha  # 渐进过渡
成功实现0.2速度追踪，正常

2.	修改objective_function.py中的速度权重，发现运行demo还是老样子-------在demo中强制
	覆盖，改成350,300,300



###### 2025-12-17
完成：

进行中：

踩坑及解决：




